# NetSpeedMonitor 使用说明

## 快速开始

### 编译和运行

```bash
# 克隆项目
git clone <repository-url>
cd NetSpeedMonitor

# 运行（开发模式）
swift run

# 编译发布版本
swift build -c release

# 运行发布版本
.build/release/NetSpeedMonitor
```

## 功能说明

### 1. 菜单栏显示

应用启动后会在菜单栏显示实时网速：

```
↓  123.4 KB/s
↑   45.6 KB/s
```

- 第一行：下载速度（↓）
- 第二行：上传速度（↑）
- 使用等宽字体，固定宽度显示

### 2. 详细信息面板

**点击菜单栏图标**会弹出详细信息面板，包含：

#### 当前速度
显示当前的上传和下载速度（大字体）

#### 速度图表
```
┃▁▂▅▇█▆▃▂┃ 最近 20 秒
```
使用条形图显示最近 20 秒的速度变化趋势

#### 网络信息
- **SSID**：当前连接的 WiFi 名称
- **IP**：本地 IP 地址（如 192.168.1.33）
- **外网**：公网 IP 地址
- **Ping**：网络延迟（毫秒）

#### 流量统计
- **今日使用**：今天累计使用的流量
- **本月使用**：本月累计使用的流量

注意：流量统计在应用运行期间累计，重启后清零

#### Top 流量进程
显示占用网络流量最多的 3 个应用程序：
```
Safari          ⬇ 4.2 MB/s
Chrome          ⬆ 1.1 MB/s
Xcode           ⬇ 0.8 MB/s
```

- 每 3 秒更新一次
- 使用 `nettop` 命令获取实时数据
- 自动合并同名进程的流量

#### 网络健康
- **网络健康**：良好/一般/较差
- **丢包**：丢包率百分比
- **信号**：WiFi 信号强度（dBm）

### 3. 退出应用

两种方式退出：
1. 在详细信息面板点击"退出"按钮
2. 使用快捷键 `Command + Q`

## 技术说明

### 网络速度监控

- 使用 `getifaddrs()` 系统 API 获取网络接口数据
- 每秒采样一次，计算字节差值得到速度
- 过滤回环接口（lo0），只统计真实网络流量
- 支持所有网络接口（WiFi、以太网、VPN 等）

### 进程流量监控

使用 macOS 系统命令 `nettop`：
```bash
nettop -P -L 1 -J bytes_in,bytes_out -x
```

参数说明：
- `-P`：按进程分组
- `-L 1`：只采样一次
- `-J bytes_in,bytes_out`：只显示接收和发送字节数
- `-x`：不显示表头

如果 `nettop` 不可用，会自动使用 `lsof` 作为备用方案。

### 网络信息获取

- **本地 IP**：通过 `getifaddrs()` 获取 en0 接口的 IPv4 地址
- **外网 IP**：调用 https://api.ipify.org API
- **Ping 延迟**：执行 `ping -c 1 -t 2 8.8.8.8` 命令
- **WiFi 信息**：简化版本（完整版需要 CoreWLAN 框架）

## 权限说明

应用不需要特殊权限，但某些功能可能受限：

- **网络监控**：无需权限，使用标准系统 API
- **进程监控**：使用系统命令，无需额外权限
- **WiFi SSID**：完整功能需要位置权限（当前为简化版）

## 性能优化

- 网络速度每秒更新一次
- 进程流量每 3 秒更新一次（减少 CPU 占用）
- 后台线程执行耗时操作，不阻塞 UI
- `nettop` 命令设置 2 秒超时，防止卡死

## 故障排除

### 进程流量显示"正在检测..."

可能原因：
1. `nettop` 命令执行超时
2. 系统权限限制
3. 没有活跃的网络连接

解决方法：
- 等待几秒钟，会自动重试
- 确保有网络活动（打开浏览器等）
- 检查终端是否有错误输出

### 外网 IP 显示"获取失败"

可能原因：
1. 没有互联网连接
2. API 服务不可用
3. 防火墙阻止

解决方法：
- 检查网络连接
- 稍后会自动重试

### Ping 显示"超时"

可能原因：
1. 网络不稳定
2. 防火墙阻止 ICMP
3. DNS 问题

解决方法：
- 检查网络连接
- 应用会继续运行，只是延迟数据不准确

## 开发说明

### 项目结构

```
Sources/NetSpeedMonitor/
├── NetSpeedApp.swift          # 应用入口和 UI
├── NetworkStats.swift         # 网络监控核心逻辑
└── DetailedStatsView.swift    # 详细信息面板 UI
```

### 添加新功能

1. 在 `NetworkStats.swift` 中添加数据属性（使用 `@Published`）
2. 在 `DetailedStatsView.swift` 中添加 UI 显示
3. 编译测试：`swift build`

### 调试

运行时会在终端输出调试信息，可以查看：
- 网络速度数据
- 进程监控结果
- 错误信息

## 常见问题

**Q: 为什么速度和系统监视器不一样？**

A: 不同工具的采样频率和计算方法可能不同，本应用每秒采样一次，显示的是瞬时速度。

**Q: 可以监控特定网络接口吗？**

A: 当前版本监控所有非回环接口的总流量。如需监控特定接口，可以修改 `NetworkStats.swift` 中的过滤条件。

**Q: 流量统计准确吗？**

A: 流量统计基于系统接口数据，准确度高。但只统计应用运行期间的流量，重启后清零。

**Q: 可以设置流量提醒吗？**

A: 当前版本不支持，这是一个很好的功能建议，可以在未来版本中添加。

## 贡献

欢迎提交 Issue 和 Pull Request！

## 许可证

MIT License
